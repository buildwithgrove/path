# Portal Database API <!-- omit in toc -->

**PostgREST configuration** for the Portal Database.

PostgREST automatically generates a REST API from the PostgreSQL database schema.

## Table of Contents <!-- omit in toc -->

- [QuickStart](#quickstart)
- [Walkthrough](#walkthrough)
- [Authentication](#authentication)
  - [Auth Summary](#auth-summary)
  - [JWKS Configuration](#jwks-configuration)
  - [Database Roles](#database-roles)
  - [Row-Level Security (RLS)](#row-level-security-rls)
  - [Testing auth locally](#testing-auth-locally)
  - [JWT Generation (Backend/Internal Use)](#jwt-generation-backendinternal-use)
- [How it Works](#how-it-works)
- [üìö Resources](#-resources)

## QuickStart

Run `make quickstart` for a guided walkthrough.

Run `make` to see a list of available commands.

## Walkthrough

The following is a minimal walkthrough to get started running the Portal DB API
and sending a few requests locally:

```bash
# Start PostgreSQL + PostgREST (port 3000)
cd portal-db
make portal-db-up

# Add test data
make postgrest-hydrate-testdata

# Admin token (copy export command)
make postgrest-gen-jwt admin

# Reader token (optional)
make postgrest-gen-jwt reader

# Paste the export commands here
export JWT_TOKEN_ADMIN="..."
export JWT_TOKEN_READER="..."

# Test the API
curl http://localhost:3000/networks -H "Authorization: Bearer $JWT_TOKEN_READER" | jq
curl http://localhost:3000/organizations -H "Authorization: Bearer $JWT_TOKEN_READER" | jq
curl http://localhost:3000/portal_accounts -H "Authorization: Bearer $JWT_TOKEN_READER" | jq
curl -X POST http://localhost:3000/portal_applications \
  -H "Authorization: Bearer $JWT_TOKEN_ADMIN" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=representation" \
  -d '{"portal_account_id":"10000000-0000-0000-0000-000000000004","portal_application_name":"CLI Quickstart App","secret_key_hash":"demo","secret_key_required":false}' \
  | jq

# Refresh OpenAPI spec before launching Swagger UI
make postgrest-generate-openapi

# Launch Swagger UI
make postgrest-swagger-ui
```

## Authentication

The PostgREST API uses **dual JWT authentication** to support both internal services and frontend users.

### Auth Summary

PostgREST authenticates requests using JWTs (JSON Web Tokens) with two different signing methods:

1. **Backend/Internal JWTs (HS256)** - For backend services and engineers
   - Algorithm: HMAC-SHA256 (symmetric key)
   - Use case: Internal tools, backend services, admin operations
   - Roles: `portal_db_admin`, `portal_db_reader`
   - Generated locally via `make postgrest-gen-jwt`
   
2. **Auth0 User JWTs (RS256)** - For frontend users
   - Algorithm: RSA-SHA256 (asymmetric key)
   - Use case: Frontend application users authenticated via Auth0
   - Role: `authenticated_user` (with user-scoped RLS policies)
   - Generated by Auth0 at https://auth.grove.city/

Both JWT types are verified using a **JWKS (JSON Web Key Set)** file that contains:
- HS256 symmetric key for backend JWTs (no `kid` in header)
- RS256 public key from Auth0 (with `kid="1a2b3c4d5e6f7g8h9i0j"` in header)

### JWKS Configuration

The JWKS file (`api/jwks.json`) is **gitignored** and contains sensitive key material.

**üåø GROVE EMPLOYEES ONLY:**
```bash
# Download JWKS from 1Password (requires 1Password CLI)
make grove-download-jwks
```

This command fetches the production JWKS file containing both the internal HS256 secret and the Auth0 RS256 public key.

### Database Roles

- `authenticator` - "Chameleon" role used exclusively by PostgREST for JWT authentication (no direct API access)
- `portal_db_admin` - JWT-backed role with full read/write access (backend services)
- `portal_db_reader` - JWT-backed role with read-only access (backend services)
- `authenticated_user` - JWT-backed role for Auth0 users with user-scoped RLS policies (see [004_grove_portal_access.sql](../schema/004_grove_portal_access.sql))
- `anon` - Default unauthenticated role with no privileges

### Row-Level Security (RLS)

Frontend users authenticated via Auth0 are subject to **Row-Level Security** policies:
- Users can only access `portal_accounts` and `portal_applications` they have explicit RBAC permissions for
- Permission levels: `legacy_read` (SELECT) and `legacy_write` (INSERT/UPDATE/DELETE)
- Unauthorized access returns an empty array `[]` (by design, to prevent information leakage)

See [004_grove_portal_access.sql](../schema/004_grove_portal_access.sql) for RLS policy details.

### Testing auth locally

Run `make` from the `portal-db` directory shows the following scripts which can be used to test things locally:

```bash
=== üîê Authentication & Testing ===
test-postgrest-auth                Test JWT authentication flow
test-postgrest-portal-app-creation Test portal application creation and retrieval via authenticated Postgres flow
postgrest-gen-jwt                  Generate JWT token
```

### JWT Generation (Backend/Internal Use)

The `postgrest-gen-jwt` script generates HS256 JWTs for backend services and internal development:

```bash
# Generate admin JWT (full read/write access)
make postgrest-gen-jwt

# Generate reader JWT (read-only access)
JWT_ROLE=portal_db_reader make postgrest-gen-jwt

# Customize email, expiration
JWT_EMAIL=user@example.com JWT_EXPIRES=24h make postgrest-gen-jwt

# Token-only output (for scripting)
export POSTGREST_JWT_TOKEN=$(cd api/scripts && ./postgrest-gen-jwt.sh --token-only)
curl -H "Authorization: Bearer $POSTGREST_JWT_TOKEN" http://localhost:3000/networks
```

See `./api/scripts/postgrest-gen-jwt.sh --help` for full documentation.

## How it Works

**PostgREST** introspects PostgreSQL schema and auto-generates REST endpoints:

```bash
Database Schema ‚Üí PostgREST ‚Üí OpenAPI Spec ‚Üí (Coming Soon) SDKs (Go, TypeScript, etc...)
```

## üìö Resources

- [PostgREST Documentation](https://postgrest.org/en/stable/)
- [OpenAPI Specification](https://swagger.io/specification/)
